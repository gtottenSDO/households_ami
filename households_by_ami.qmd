---
title: Households by AMI
bibliography: references.bib
format:
  html:
   code-fold: true
   code-summary: "Show the code"
   code-tools: true
   toc: true
   output: false
---

## Statutory Requirements

Per C.R.S. 24-32-3702(1)(b),

> **(b)**Â No later than November 30, 2027, and every six years thereafter, the director shall conduct a statewide housing needs assessment that analyzes existing and future statewide housing needs. The director shall publish a report based on the statewide housing needs assessment and regional and local housing needs assessments accepted by the department pursuant to section 24-32-3703 (3) or 24-32-3704 (3) that identifies current housing stock and estimates the number and type of dwelling units needed to accommodate future housing needs of the state based on population change projections. The report shall categorize statewide housing needs by ***household size***; ***household type***, including *accessible*, *visitable*, *supportive*, ***affordable for-sale***, and ***affordable rental housing***; and ***household income levels***, including *extremely low-*, *very low-*, *low-*, *moderate-*, and *middle-income* households as designated by the United States department of Housing and Urban Development ("HUD").

In pursuing these requirements, we will begin by establishing a historic time series of housing data, including the number of housing units by type and income level, utilizing data from the Census Bureau's Public Use Microdata Sample (PUMS), and then forecast future marginal demand based on our projections of total households by type.

## Data Collection

This script is used to pull the number of households by AMI in Colorado using PUMS data via IPUMS using the `ipumsr` package. Median Family Incomes are collected separately as provided by HUD, using the `tidycensus` package.

```{r}
#| label: setup
# NOTE: To load data, you must download both the extract's data and the DDI
# and also set the working directory to the folder with these files (or change the path below).
if (!require("ipumsr")) stop("Reading IPUMS data into R requires the ipumsr package. It can be installed using the following command: install.packages('ipumsr')")
library(tidyverse)
library(srvyr)
library(tidycensus)
library(duckplyr)

# get hud IL data
library(hudr)
hud_key <- Sys.getenv("HUD_API_KEY")
```

## Median Family Income

### Years 2005-2023 (except 2020) - ACS API

We begin by using the `tidycensus` package to pull the median family income data from the ACS 1 year dataset for each year. This data is available from the ACS API for years 2005-2019 and 2021-2023. Year prior to 2005 are not accessible via the API, and are extracted separtely below. Year 2020 data was never released from the Census Bureau, and is therefore not included.

```{r}
#| label: acs_years

acs_years <- c(2005:2019, 2021:2023)
```

### Years 2000-2004 - FTP download

The `get_acs` function is used to pull the data for each year, and the results are combined into a single dataframe, `acs_mfi`. The data is saved to a file so that it does not need to be downloaded again.

```{r}
#| label: acs_mfi

# check if file exists and read it if it does
if (!file.exists("data/acs_mfi.rds")) {
  acs_mfi <- map(
    acs_years,
    ~ get_acs(
      geography = "state",
      variables = "B19113_001",
      state = "CO",
      year = .x,
      survey = "acs1"
    ) |>
      mutate(year = .x, .before = 1)
  ) |>
    bind_rows()

  write_rds(acs_mfi, "data/acs_mfi.rds")
} else {
  acs_mfi <- read_rds("data/acs_mfi.rds") |>
    as_duckplyr_df()
}
```

The remaining data was downloaded from the ACS FTP server and saved as `MultiYearProfiles0402004.csv`. The data is filtered based on the `Stub` "Median family income (dollars)" and the `Geographic Name` "Colorado". The data is then renamed as variable "B19113_001", in order to match the variable name used in the ACS API, and appended to the `acs_mfi` data frame, generated above.

```{r}
#| label: mfi_00_04

mfi_00_04 <- read_csv("MultiYearProfiles0402004.csv") |>
  filter(Stub == "Median family income (dollars)" & `Geographic Name` == "Colorado") |>
  select(NAME = `Geographic Name`, contains("Estimate")) |>
  pivot_longer(
    cols = contains("Estimate"),
    names_to = "year",
    values_to = "estimate",
    values_transform = as.numeric
  ) |>
  mutate(
    GEOID = "08",
    variable = "B19113_001",
    year = as.integer(str_extract(year, "\\d{4}"))
  ) |>
as_duckplyr_df()
#   |>
# select(year = 'Year', mfi = 'Estimate') |>
# mutate(year = as.numeric(year))
```

## Household Data (IPUMS)

PUMS data is extracted using IPUMS USA data collection [@Ruggles2024]. The dataset and accompanying application have been created as a way of extracting and standardizing PUMS data for analysis. Data is extracted using the `ipumsr` package [@ipumsr].

First we get a list of all ACS samples, and filter to those with the pattern `us20\d{2}a`. This pattern matches all ACS 1 year samples from 2000 to 2023, and are used to feed the query from IPUMS.

```{r}
#| label: ipums_samples

acs_samples <- get_sample_info("usa") |>
  filter(str_detect(name, pattern = "us20\\d{2}a")) |>
  pull(name)
```

Next an extract is created and processed. The following table includes relevant variables and their definitions:

| Variable  | Description                                 |
|-----------|---------------------------------------------|
| STATEFIP  | State FIPS code                             |
| COUNTYFIP | County FIPS code                            |
| PUMA      | Public Use Microdata Area code              |
| NUMPREC   | Number of people in the household           |
| CPI99     | Consumer Price Index for 1999               |
| OWNERSHP  | Ownership status of the housing unit        |
| OWNCOST   | Value of owner-occupied housing units       |
| RENT      | Gross rent                                  |
| HHTYPE    | Household type                              |
| HHINCOME  | Household income                            |
| INCTOT    | Total income                                |
| INCWAGE   | Wage or salary income                       |
| INCBUS00  | Business, farm, and professional income     |
| INCSS     | Social security income                      |
| INCWELFR  | Welfare income                              |
| INCINVST  | Investment income                           |
| INCSUPP   | Supplemental security income                |
| INCOTHER  | Other income                                |
| INCEARN   | Earnings                                    |
| POVERTY   | Poverty status                              |
| CBPOVERTY | Child below poverty level                   |
| AGE       | Age of the person                           |
| FAMUNIT   | Family unit                                 |
| FAMSIZE   | Family size                                 |
| NCHILD    | Number of children in the household         |
| NCHLT5    | Number of children under 5 years old        |
| FTOTINC   | Total family income                         |
| BEDROOMS  | Number of bedrooms                          |
| REPWT     | Replicate weight (for statistical analysis) |

: IPUMS Variables

The output of the IPUMS query is a data frame that includes a record for each household in Colorado from the ACS 1-year samples since 2000. Each record represents a person, with the head of household identified as person 1, and all other persons in the household following. This is based on the `rectangular` record format from IPUMS, rather than `hierachal`, as the household records lack necessary data for the analysis, such as person ages, or number of children in the household.

```{r}
#| label: query_ipums

ipums_file <- "usa_00074.xml"
file_loc <- paste0(
  "data/ipums_raw/", 
  ipums_file)
if (file.exists(file_loc)) {
  acs_00_23 <- read_ipums_ddi(ipums_file) |>
    read_ipums_micro()
} else {
  duckplyr::methods_overwrite()
  acs_extract <- define_extract_micro(
    collection = "usa",
    description = "ACS 1 year samples in Colorado of income variables, all samples since 2000",
    samples = acs_samples,
    variables = list(
      var_spec("STATEFIP", case_selections = "08"),
      "COUNTYFIP",
      "PUMA",
      "NUMPREC",
      "CPI99",
      "OWNERSHP",
      "OWNCOST",
      "RENT",
      "RENTGRS",
      "RELATE",
      "RACE",
      "SEX",
      "HISPAN",
      "BPL",
      "CITIZEN",
      "HHTYPE",
      "HHINCOME",
      "INCTOT",
      "INCWAGE",
      "INCBUS00",
      "INCSS",
      "INCWELFR",
      "INCINVST",
      "INCSUPP",
      "INCOTHER",
      "INCEARN",
      "POVERTY",
      "CBPOVERTY",
      "AGE",
      "FAMUNIT",
      "FAMSIZE",
      "NCHILD",
      "NCHLT5",
      "FTOTINC",
      "BEDROOMS",
      "MOVEDIN",
      "REPWT"
    )
  ) |>
    submit_extract() |>
    wait_for_extract() |>
    download_extract() |>
    read_ipums_micro()
}

```

### Modify IPUMS Data

Next a series of calculations are performed to modify the IPUMS data to be more useful for analysis. The following table includes the variables generated and their descriptions.

| Variable Name | Description |
|--------------------------------------|----------------------------------|
| hhsize | Household size - equal, to the total number of person records, `NUMREC`) |
| nadults | Number of adults in the household - total number of persons records - number of children (`NUMREC - NCHILD`) |
| household_type_id | Household type - a factor variable with four levels: "One adult with no children", "One adult with children", "More than one adult with no children", "More than one adult with children" - based on characteristics of the household |
| age_group | Age group - a factor variable with five levels: "Under 18", "18-24", "25-44", "45-64", "65 and over" - based on the age of the person |
| hhadj | An adjustment factor to apply to household income based on the size of the household |
| mfi_hh | Household median family income - household income adjusted for household size |
| pct_mfi | Percent of median family income - household income divided by the median family income |
| ami_group | Grouping of households by Median Family Income |
| ami_percentile | Percent of median family income based on 10 percentile groups |
| housing_cost_pct | Housing cost as a percentage of income |

Of particular importance is the method for calculating percentage of median family income, which is based on the adjusted median family income as determined by household size. This is done by first applying an adjustment factor based on Median Family Income (based on HUD calculations), and then applying this adjustment factor to actual Median Family Income, to get a size adjusted MFI that household income can be compared to. Household income is then divided by this adjusted MFI to get the percentage of median family income, used for binning and grouping.

Cost burdened status is taken by dividing housing costs by household income. Housing costs are based either on the `RENT`^[Note: the `RENT` variable provided by IPUMS represents monthly contract rents, which may or may not include utilities, based on ] variable for renter households, or the `OWNCOST` variable for owner households, and are assigned based on tenure of the household. Housing costs are each reported on a monthly basis, and so must be annualized by multiplying by 12, prior to dividing by household income.
```{r}
#| label: calc_amis

acs_amis <- as_duckplyr_df(acs_00_23) |>
  left_join(
    acs_mfi |>
      bind_rows(mfi_00_04) |>
      select("YEAR" = "year", mfi = estimate)
  ) |>
  mutate(
    nadults = NUMPREC - NCHILD,
    hhsize = NUMPREC,
    household_type_id = factor(case_when(
      nadults == 1 & NCHILD == 0 ~ "One adult with no children	",
      nadults == 1 & NCHILD > 0 ~ "One adult with children",
      nadults > 1 & NCHILD == 0 ~ "More than one adult with no children",
      nadults > 1 & NCHILD > 0 ~ "More than one adult with children"
    )),
    age_group = cut(
      AGE,
      breaks = c(
        0,
        18,
        25,
        45,
        65,
        Inf
      ),
      labels = c(
        "Under 18",
        "18-24",
        "25-44",
        "45-64",
        "65 and over"
      ),
      right = FALSE,
      ordered_result = TRUE
    ),
    hhadj = case_when(
      hhsize < 4 ~ 1 - (4 - hhsize) * .1,
      hhsize > .4 ~ 1 + (hhsize - 4) * .08,
      .default = 1
    ),
    mfi_hh = mfi * hhadj,
    pct_mfi = HHINCOME / mfi_hh,
    ami_group = cut(
      pct_mfi,
      breaks = c(
        0, 
        .3, 
        .5, 
        .8, 
        1, 
        Inf),
      labels = c(
        "0-30", 
        "30-50", 
        "50-80", 
        "80-100", 
        "100+"),
      right = FALSE,
      ordered_result = TRUE
    ),
    ami_percentile = ceiling(pct_mfi*10) / 10,
      tenure = as_factor(OWNERSHP),
      tenure_detail = as_factor(OWNERSHPD),
    housing_cost_pct = case_when(
      OWNERSHP == 2 ~ RENT*12 / HHINCOME,
      OWNERSHP == 1 ~ OWNCOST*12 / HHINCOME,
      .default = NA_real_
    ),
    cost_burdened_30 = case_when(
      housing_cost_pct >= .3 ~ TRUE,
      .default = FALSE),
    cost_burdened_50 = case_when(
      housing_cost_pct >= .5 ~ TRUE,
      .default = FALSE)
  )
```

## Calculate AMI percentiles by year

Next we calculate the AMI percentiles by year. We do this by grouping the data by year, household type, AMI percentile, AMI group^[While this is duplicative with AMI percentiles it makes future analysis simpler], age group, cost burdened 30, cost burdened 50, tenure, tenure detail, and household size. We then calculate the total household weight for each group. We also join the median family income (MFI) for each year.
```{r}
#| label: calc_ami_percentiles_by_year

ami_percentile_by_year <- acs_amis |>
  filter(PERNUM == 1 & GQ == 1 & HHINCOME != 9999999 & HHINCOME > 0 & !(YEAR %in% c(2020))) |>
  summarize(
    total_hh = sum(HHWT), 
    .by = c(
      YEAR, 
      household_type_id, 
      ami_group,
      ami_percentile, 
      age_group, 
      cost_burdened_30, cost_burdened_50, 
      tenure, tenure_detail, hhsize)) |>
  arrange(YEAR, ami_percentile, household_type_id, age_group) |>
  left_join(acs_mfi |>
    select(YEAR = year, mfi=estimate))
```

## Write CSVs

Finally we write the CSVs to the data folder for the ACS AMIs and the AMI percentiles by year.

```{r}
#| label: write_csvs
write_csv(ami_percentile_by_year, "data/ami_percentile_by_year_long.csv")

write_csv(acs_amis, "data/acs_amis.csv")
```
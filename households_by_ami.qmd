---
title: Households by AMI
bibliography: references.bib
---

## Statutory Requirements

Per C.R.S. 24-32-3702(1)(b),

> **(b)**Â No later than November 30, 2027, and every six years thereafter, the director shall conduct a statewide housing needs assessment that analyzes existing and future statewide housing needs. The director shall publish a report based on the statewide housing needs assessment and regional and local housing needs assessments accepted by the department pursuant to section 24-32-3703 (3) or 24-32-3704 (3) that identifies current housing stock and estimates the number and type of dwelling units needed to accommodate future housing needs of the state based on population change projections. The report shall categorize statewide housing needs by ***household size***; ***household type***, including *accessible*, *visitable*, *supportive*, ***affordable for-sale***, and ***affordable rental housing***; and ***household income levels***, including *extremely low-*, *very low-*, *low-*, *moderate-*, and *middle-income* households as designated by the United States department of housing and urban development.

In pursuing these requirements, we will begin by establishing a historic time series of housing data, including the number of housing units by type and income level, utilizing data from the Census Bureau's Public Use Microdata Sample (PUMS), and then forecast future marginal demand based on our projections of total households by type.

## Data Collection

This script is used to pull the number of households by AMI in Colorado using PUMS data via IPUMS using the `ipumsr` package. Median Family Incomes are collected separately as provided by HUD, using the `tidycensus` package.

```{r}
#| vscode: {languageId: r}
# NOTE: To load data, you must download both the extract's data and the DDI
# and also set the working directory to the folder with these files (or change the path below).
if (!require("ipumsr")) stop("Reading IPUMS data into R requires the ipumsr package. It can be installed using the following command: install.packages('ipumsr')")
library(tidyverse)
library(srvyr)
library(tidycensus)
library(duckplyr)

# get hud IL data
library(hudr)
hud_key <- Sys.getenv("HUD_API_KEY")
```

## Median Family Income

### Years 2005-2023 (except 2020) - ACS API

We begin by using the `tidycensus` package to pull the median family income data from the ACS 1 year dataset for each year. This data is available from the ACS API for years 2005-2019 and 2021-2023. Year prior to 2005 are not accessible via the API, and are extracted separtely below. Year 2020 data was never released from the Census Bureau, and is therefore not included.

```{r}
#| vscode: {languageId: r}
acs_years <- c(2005:2019, 2021:2023)
```

### Years 2000-2004 - FTP download

The `get_acs` function is used to pull the data for each year, and the results are combined into a single dataframe, `acs_mfi`. The data is saved to a file so that it does not need to be downloaded again.

```{r}
#| vscode: {languageId: r}
if (!file.exists("acs_mfi.rds")) {
  acs_mfi <- map(
    acs_years,
    ~ get_acs(
      geography = "state",
      variables = "B19113_001",
      state = "CO",
      year = .x,
      survey = "acs1"
    ) |>
      mutate(year = .x, .before = 1)
  ) |>
    bind_rows()

  write_rds(acs_mfi, "acs_mfi.rds")
} else {
  acs_mfi <- read_rds("acs_mfi.rds")
}
```

The remaining data was downloaded from the ACS FTP server and saved as `MultiYearProfiles0402004.csv`. The data is filtered based on the `Stub` "Median family income (dollars)" and the `Geographic Name` "Colorado". The data is then renamed as variable "B19113_001", in order to match the variable name used in the ACS API, and appended to the `acs_mfi` data frame, generated above.

```{r}
#| vscode: {languageId: r}
mfi_00_04 <- read_csv("MultiYearProfiles0402004.csv") |>
  filter(Stub == "Median family income (dollars)" & `Geographic Name` == "Colorado") |>
  select(NAME = `Geographic Name`, contains("Estimate")) |>
  pivot_longer(
    cols = contains("Estimate"),
    names_to = "year",
    values_to = "estimate",
    values_transform = as.numeric
  ) |>
  mutate(
    GEOID = "08",
    variable = "B19113_001",
    year = as.integer(str_extract(year, "\\d{4}"))
  )
#   |>
# select(year = 'Year', mfi = 'Estimate') |>
# mutate(year = as.numeric(year))
```

## Household Data (IPUMS)

PUMS data is extracted using IPUMS USA data collection [@Ruggles2024]. The dataset and accompanying application have been created as a way of extracting and standardizing PUMS data for analysis.

```{r}
#| editable: true
#| slideshow: {slide_type: ''}
#| tags: []
#| vscode: {languageId: r}
acs_samples <- get_sample_info("usa") |>
  filter(str_detect(name, pattern = "us20\\d{2}a")) |>
  pull(name)
```

```{r}
#| vscode: {languageId: r}
ipums_file <- "usa_00067.xml"
if (file.exists(ipums_file)) {
  acs_00_23 <- read_ipums_ddi(ipums_file) |>
    read_ipums_micro()
} else {
  acs_00_23 <- define_extract_micro(
    collection = "usa",
    description = "ACS 1 year samples in Colorado of income variables, all samples since 2000",
    samples = acs_samples,
    variables = list(
      var_spec("STATEFIP", case_selections = "08"),
      "COUNTYFIP",
      "PUMA",
      "NUMPREC",
      "CPI99",
      "OWNERSHP",
      "HHTYPE",
      "HHINCOME",
      "INCTOT",
      "INCWAGE",
      "INCBUS00",
      "INCSS",
      "INCWELFR",
      "INCINVST",
      "INCSUPP",
      "INCOTHER",
      "INCEARN",
      "POVERTY",
      "CBPOVERTY",
      "AGE",
      "FAMUNIT",
      "FAMSIZE",
      "NCHILD",
      "NCHLT5",
      "FTOTINC"
    )
  ) |>
    submit_extract() |>
    wait_for_extract() |>
    download_extract() |>
    read_ipums_micro()
}
```

```{r}
#| vscode: {languageId: r}
acs_amis <- as_duckplyr_df(acs_00_23) |>
  left_join(
    acs_mfi |>
      bind_rows(mfi_00_04) |>
      select("YEAR" = "year", mfi = estimate)
  ) |>
  mutate(
    nadults = NUMPREC - NCHILD,
    hhsize = NUMPREC,
    household_type_id = factor(case_when(
      nadults == 1 & NCHILD == 0 ~ "One adult with no children	",
      nadults == 1 & NCHILD > 0 ~ "One adult with children",
      nadults > 1 & NCHILD == 0 ~ "More than one adult with no children",
      nadults > 1 & NCHILD > 0 ~ "More than one adult with children"
    )),
    age_group = cut(
      AGE,
      breaks = c(
        0,
        18,
        25,
        45,
        65,
        Inf
      ),
      labels = c(
        "Under 18",
        "18-24",
        "25-44",
        "45-64",
        "65 and over"
      ),
      right = FALSE,
      ordered_result = TRUE
    ),
    hhadj = case_when(
      hhsize < 4 ~ 1 - (4 - hhsize) * .1,
      hhsize > .4 ~ 1 + (hhsize - 4) * .08,
      .default = 1
    ),
    mfi_hh = mfi * hhadj,
    pct_mfi = HHINCOME / mfi_hh,
    ami_group = cut(
      pct_mfi,
      breaks = c(
        0, 
        .3, 
        .5, 
        .8, 
        1, 
        Inf),
      labels = c(
        "less than or equal to 30% of MFI", 
        "30% to 50% of MFI", 
        "50% to 80% of MFI", 
        "80% to 99% of MFI", 
        "100% MFI or greater"),
      right = FALSE,
      ordered_result = TRUE
    ),
    ami_percentile = ceiling(pct_mfi*10) * 10
  )
```

```{r}
#| vscode: {languageId: r}
ami_groups_by_year <- acs_amis |>
  filter(PERNUM == 1 & GQ == 1 & HHINCOME != 9999999 & HHINCOME > 0 & !(YEAR %in% c(2020))) |>
  summarize(total_hh = sum(HHWT), .by = c(YEAR, household_type_id, ami_group, age_group)) |>
  pivot_wider(names_from = YEAR, values_from = total_hh) |>
  arrange(ami_group, household_type_id, age_group) |>
  bind_rows(acs_mfi |>
    select(YEAR = year, estimate) |>
    pivot_wider(names_from = YEAR, values_from = estimate) |>
    mutate(ami_group = "median family income"))
```

```{r}
#| vscode: {languageId: r}
write_csv(ami_groups_by_year, "ami_groups_by_year.csv")
```

```{r}
#| vscode: {languageId: r}
# create pivot friendly table for ami groups by year

ami_groups_by_year_pivot <- ami_groups_by_year |>
    pivot_longer(-c(ami_group, household_type_id, age_group), names_to = "year", values_to = "total_hh")

write_csv(ami_groups_by_year_pivot, "ami_groups_by_year_pivot.csv")
```

```{r}
#| vscode: {languageId: r}
write_csv(acs_amis, "acs_amis.csv")
```

```{r}
#| vscode: {languageId: r}
ami_percentile_by_year <- acs_amis |>
  filter(PERNUM == 1 & GQ == 1 & HHINCOME != 9999999 & HHINCOME > 0 & !(YEAR %in% c(2020))) |>
  summarize(total_hh = sum(HHWT), .by = c(YEAR, household_type_id, ami_percentile, age_group)) |>
  pivot_wider(names_from = YEAR, values_from = total_hh) |>
  arrange(ami_percentile, household_type_id, age_group) |>
  bind_rows(acs_mfi |>
    select(YEAR = year, estimate) |>
    pivot_wider(names_from = YEAR, values_from = estimate))
```

```{r}
#| vscode: {languageId: r}
write_csv(ami_percentile_by_year, "ami_percentile_by_year.csv")
```

```{r}
#| vscode: {languageId: r}
# create pivot friendly table for ami groups by year

ami_percentile_by_year_pivot <- ami_percentile_by_year |>
    pivot_longer(-c(ami_percentile, household_type_id, age_group), names_to = "year", values_to = "total_hh")

write_csv(ami_percentile_by_year_pivot, "ami_percentile_by_year_pivot.csv")
```

```{r}
#| vscode: {languageId: r}
write_csv(acs_amis, "acs_amis.csv")
```